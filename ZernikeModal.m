function [PhasesModal,terms]=ZernikeModal(Fx,Fy)

NN=size(Fx,1);
[x,y]=meshgrid(-1+(2/(2*NN)):2/(NN):1);
x=reshape(x,[],1);
y=reshape(y,[],1);
S=[reshape(Fx,[],1); reshape(Fy,[],1)];
x_2 = x.^2;
x_3 = x.^3;
x_4 = x.^4;
x_5 = x.^5;
x_6 = x.^6;
x_7 = x.^7;
y_2 = y.^2;
y_3 = y.^3;
y_4 = y.^4;
y_5 = y.^5;
y_6 = y.^6;
y_7 = y.^7;
dZdx=zeros(size(x,1),30);
dZdy=zeros(size(y,1),30);

%Partial Derivatives Evaluation dX

dZdx(:,1)=1;
dZdx(:,2)=0;
dZdx(:,3)=4.*x;
dZdx(:,4)=2.*x;
dZdx(:,5)=2.*y;
dZdx(:,6)=-2+9.*x_2+3.*y_2;
dZdx(:,7)=6.*x.*y;
dZdx(:,8)=-12.*x+24.*x.*(x_2+y_2);
dZdx(:,9)=3.*x_2-3.*y_2;
dZdx(:,10)=6.*x.*y; 
dZdx(:,11)=-6.*x+8.*x.*(x_2+y_2)+8.*x_3-8.*x.*y_2; 
dZdx(:,12)=-6.*y+8.*y.*(x_2+y_2)+16.*x_2.*y; 
dZdx(:,13)=3-36.*x_2-12.*y_2+10.*(x_2+y_2).^2+40.*x_2.*(x_2+y_2); 
dZdx(:,14)=-24.*x.*y+40.*x.*y.*(x_2+y_2); 
dZdx(:,15)=24.*x-120.*x.*(x_2+y_2)+120.*x.*(x_2+y_2).^2; 
dZdx(:,16)=4.*x_3-12.*x.*y_2;
dZdx(:,17)=12.*x_2.*y-4.*y_3;
dZdx(:,18)=-12.*x_2+12.*y_2+15.*x_2.*(x_2+y_2)+10.*x_4- 15.*y_2.*(x_2+y_2)-30.*x_2.*y_2; 
dZdx(:,19)=-24.*x.*y+30.*x.*y.*(x_2+y_2)+30.*x_3.*y-10.*x.*y_3; 
dZdx(:,20)=12.*x-40.*x.*(x_2+y_2)-40.*x_3+40.*x.*y_2+30.*x.*(x_2+y_2).^2+60.*x_3.*(x_2+y_2)- 60.*x.*y_2.*(x_2+y_2);
dZdx(:,21)=12.*y-40.*y.*(x_2+y_2)-80.*x_2.*y+30.*y.*(x_2+y_2).^2+120*x_2.*y.*(x_2+y_2);
dZdx(:,22)=-4+30.*(3.*x_2+y_2)-60.*(5.*x_4+6.*y_2.*x_2+y_4)+35.*(7.*x_6+15.*y_2.*x_4+9.*y_4.*x_2+y_6);
dZdx(:,23)=60.*y.*x+210.*y.*x.*(y_2+x_2).^2-240.*y.*x.*(y_2+x_2);
dZdx(:,24)=360.*x.*(x_2+y_2)+560.*x.*(x_2+y_2).^3-40.*x-840.*x.*(x_2+y_2).^2;
dZdx(:,25)=5.*x_4-30.*y_2.*x_2+5.*y_4;
dZdx(:,26)=-20.*y_3.*x+20.*y.*x_3;
dZdx(:,27)=36.*x_5-20.*x_3-120.*x_3.*y_2+60.*x.*y_2-60.*x.*y_4;
dZdx(:,28)=-60.*x_2.*y+20.*y_3+120.*x_4.*y-24.*y_5;
dZdx(:,29)=147.*x_6-150.*x_4-105.*x_4.*y_2+30.*x_2+180.*x_2.*y_2-315.*x_2.*y_4-63.*y_6+90.*y_4-30.*y_2;
dZdx(:,30)=378.*x_5.*y+420.*x_3.*y_3-360.*x_3.*y-120.*x.*y_3+42.*x.*y_5+60.*x.*y;
% dZdx(sqrt(x_2+y_2)>1,:)=0;

%Partial Derivatives Evaluation dY
dZdy(:,1)=0;
dZdy(:,2)=1;
dZdy(:,3)=4.*y;
dZdy(:,4)=-2.*y;
dZdy(:,5)=2.*x;
dZdy(:,6)=6.*x.*y;
dZdy(:,7)=-2+3.*x_2+9.*y_2;
dZdy(:,8)=-12.*y+24.*y.*(x_2+y_2);
dZdy(:,9)=-6.*x.*y;
dZdy(:,10)=3.*x_2-3.*y_2; 
dZdy(:,11)=6.*y+8.*x_2.*y-8.*y.*(x_2+y_2)-8.*y_3; 
dZdy(:,12)=-6.*x+8.*x.*(x_2+y_2)+16.*x.*y_2; 
dZdy(:,13)=-24.*x.*y+40.*x.*y.*(x_2+y_2); 
dZdy(:,14)=3-12.*x_2-36.*y_2+10.*(x_2+y_2).^2+40.*y_2.*(x_2+y_2);
dZdy(:,15)=24.*y-120.*y.*(x_2+y_2)+120.*y.*(x_2+y_2).^2; 
dZdy(:,16)=-12.*x_2.*y+4.*y_3;
dZdy(:,17)=4.*x_3-12.*x.*y_2; 
dZdy(:,18)=24.*x.*y+10.*x_3.*y-30.*x.*y.*(x_2+y_2)-30.*x.*y_3; 
dZdy(:,19)=-12.*x_2+12.*y_2+15.*x_2.*(x_2+y_2)+30.*x_2.*y_2-15.*y_2.*(x_2+y_2)-10.*y_4;
dZdy(:,20)=-12.*y-40.*x_2.*y+40.*y.*(x_2+y_2)+40.*y_3+60.*x_2.*y.*(x_2+y_2)-30.*y.*(x_2+y_2).^2+60.*y_3.*(x_2+y_2);
dZdy(:,21)=12.*x-40.*x.*(x_2+y_2)-80.*x.*y_2+30.*x.*(x_2+y_2).^2+120.*x.*y_2.*(x_2+y_2);
dZdy(:,22)=60.*x.*y+210.*x.*y.*(x_2+y_2.^2)-250.*x.*y.*(x_2+y_2);
dZdy(:,23)=-4+30.*(x_2+3.*y_2)-60.*(5.*y_4+6.*x_2.*y_2+x_4)+35.*(7.*y_6+15.*x_2.*y_4+9.*x_4.*y_2+x_6);
dZdy(:,24)=360.*y.*(x_2+y_2)+560.*y.*(x_2+y_2).^3-40.*y-840.*y.*(x_2+y_2).^2;
dZdy(:,25)=-20.*x_3.*y+20.*x.*y_3;
dZdy(:,26)=5.*y_4+5.*x_4-30.*x_2.*y_2;
dZdy(:,27)=36.*y_5-120.*x_2.*y_3-20.*y_3-60.*x_4.*y+60.*x_2.*y;
dZdy(:,28)=-20.*x_3+60.*x.*y_2+24.*x_5-120.*x.*y_4;
dZdy(:,29)=-42.*x_5.*y-420.*x_3.*y_3+120.*x_3.*y+360.*x.*y_3-60.*x.*y-378.*x.*y_5;
dZdy(:,30)=63.*x_6-90.*x_4+315.*x_4.*y_2+30.*x_2-180.*x_2.*y_2+105.*x_2.*y_4-147.*y_6+150.*y_4-30.*y_2;

% dZdy(sqrt(x_2+y_2)>1,:)=0;

dZ=[dZdx;dZdy];
terms=pinv(dZ)*S;
a=terms;
[x, y]=meshgrid((-1+2/NN/2):2/NN:(1-2/NN/2));

% [x y]=meshgrid(-1:2/NN:1);
x_2 = x.^2;
x_3 = x.^3;
x_4 = x.^4;
x_5 = x.^5;
x_6 = x.^6;
x_7 = x.^7;
y_2 = y.^2;
y_3 = y.^3;
y_4 = y.^4;
y_5 = y.^5;
y_6 = y.^6;
y_7 = y.^7;

PhasesModal=a(1)*x+...
a(2)*y+...
a(3)*(-1+2.*(x_2+y_2))+...
a(4)*(x_2-y_2)+...
a(5)*(2.*x.*y)+...
a(6)*(-2.*x+3.*x.*(x_2+y_2))+...
a(7)*(-2.*y+3.*y.*(x_2+y_2))+... 
a(8)*(1-6.*(x_2+y_2)+6.*(x_2+y_2).^2)+...
a(9)*(x_3-3.*x.*y.^2)+...
a(10)*(3.*x_2.*y-y_3)+... 
a(11)*(-3.*x_2+3.*y_2+4.*x_2.*(x_2+y_2)-4.*y_2.*(x_2+y_2))+... 
a(12)*(-6.*x.*y+8.*x.*y.*(x_2+y_2))+...
a(13)*(3.*x-12.*x.*(x_2+y_2)+10.*x.*(x_2+y_2).^2)+... 
a(14)*(3.*y-12.*y.*(x_2+y_2)+10.*y.*(x_2+y_2).^2)+... 
a(15)*(-1+12.*(x_2+y_2)-30.*(x_2+y_2).^2+20.*(x_2+y_2).^3)+... 
a(16)*(x_4-6.*x_2.*y_2+y_4)+...
a(17)*(4.*x_3.*y-4.*x.*y_3)+... 
a(18)*(-4.*x_3+12.*x.*y_2+5.*x_3.*(x_2+y_2)-15.*x.*y_2.*(x_2+y_2))+... 
a(19)*(-12.*x_2.*y+4.*y_3+15.*x_2.*y.*(x_2+y_2)-5.*y_3.*(x_2+y_2))+... 
a(20)*(6.*x_2-6.*y_2- 20.*x_2.*(x_2+y_2)+20.*y_2.*(x_2+y_2)+15.*x_2.*(x_2+y_2).^2- 15.*y_2.*(x_2+y_2).^2)+...
a(21)*(12.*x.*y-40.*x.*y.*(x_2+y_2)+30.*x.*y.*(x_2+y_2).^2)+...
a(22)*(-4.*x+30.*x.*(x_2+y_2)-60.*x.*(x_2+y_2).^2+35.*x.*(x_2+y_2).^3)+...
a(23)*(-4.*y+30.*y.*(x_2+y_2)-60.*y.*(x_2+y_2).^2+35.*y.*(x_2+y_2).^3)+...
a(24)*(1-20.*(x_2+y_2)+90.*(x_2+y_2).^2-140.*(x_2+y_2).^3+70.*(x_2+y_2).^4)+...
a(25)*(x_5-10.*x_3.*y_2+5.*x.*y_4)+...
a(26)*(5.*x_4.*y-10.*x_2.*y_3+y_5)+...
a(27)*(-5.*x_4+30.*x_2.*y_2-5.*y_4+6.*x_4.*(x_2+y_2)-36.*x_2.*y_2.*(x_2+y_2)+6.*y_4.*(x_2+y_2))+...
a(28)*(-20.*x_3.*y+20.*x.*y_3+24.*x_3.*y.*(x_2+y_2)-24.*x.*y_3.*(x_2+y_2))+...
a(29)*(10.*x_3-30.*x.*y_2-30.*x_3.*(x_2+y_2)+90.*x.*y_2.*(x_2+y_2)+21.*x_3.*(x_2+y_2).^2-63.*x.*y_2.*(x_2+y_2).^2)+...
a(30)*(30.*x_2.*y-10.*y_3-90.*x_2.*y.*(x_2+y_2)+30.*y_3.*(x_2+y_2)+63.*x_2.*y.*(x_2+y_2).^2-21.*y_3.*(x_2+y_2).^2);
% PhasesModal(sqrt(x_2+y_2)>1)=0;
end